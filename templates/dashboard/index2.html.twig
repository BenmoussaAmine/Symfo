{% extends 'base.html.twig' %}

{% block title %}Hello AssureController!{% endblock %}
{% block css %}
    <style>
        /* Center the loader */
        .disabledbutton {
            pointer-events: none;
            opacity: 0.4;
        }

        #loader {
            position: absolute;
            left: 50%;
            top: 50%;
            z-index: 1;
            width: 120px;
            height: 120px;
            margin: -76px 0 0 -76px;
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            -webkit-animation: spin 2s linear infinite;
            animation: spin 2s linear infinite;
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Add animation to "page content" */
        .animate-bottom {
            position: relative;
            -webkit-animation-name: animatebottom;
            -webkit-animation-duration: 1s;
            animation-name: animatebottom;
            animation-duration: 1s
        }

        @-webkit-keyframes animatebottom {
            from { bottom:-100px; opacity:0 }
            to { bottom:0px; opacity:1 }
        }

        @keyframes animatebottom {
            from{ bottom:-100px; opacity:0 }
            to{ bottom:0; opacity:1 }
        }

        #myDiv {
            display: none;
            text-align: center;
        }
    </style>

{% endblock %}

{% block body %}

    <!-- page content -->
    <div class="right_col" role="main">
        <div class="">
            <div class="page-title">
                <div class="title_left">
                    <h3>Statistiques</h3>
                </div>


            </div>

            <div class="clearfix"></div>

            <div class="row">
                <div class="col-md-12 col-sm-12  ">
                    <div class="x_panel">
                        <div class="x_title">
                            <h2>Statistiques</h2>
                            <ul class="nav navbar-right panel_toolbox">
                                <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                </li>

                                <li><a class="close-link"><i class="fa fa-close"></i></a>
                                </li>
                            </ul>
                            <div class="clearfix"></div>
                        </div>
                        <div class="x_content">
                            <!--- baaaaarrrr ------------------------------------------------------ -->



                            <!--- end / baaaaarrrr ------------------------------------------------------ -->
                            <div class="form-group row">

                                <div id="tabList" class="col-md-6 col-sm-6 ">


                                    <select  class="form-control"  >
                                        <option>Table </option>
                                    </select>


                                </div>
                                <div id="chartList"  class="col-md-6 col-sm-6 ">
                                    <select class="form-control"  onchange="showGraph(this.value)">
                                        <option>Type Chart</option>
                                        <!--    <option value="Pie Chart">Pie Chart</option>
                                        <option value="Bar Chart">Bar Chart</option>
                                          <option value="Line Chart">Line Chart</option> -->
                                    </select>
                                </div>



                            </div>


                            <div class="form-group row">
                                <div  id="col1List" class="col-md-6 col-sm-6 ">
                                    <div id="cblist">

                                    </div>
                                </div>
                                <div id="col2List"  class="col-md-6 col-sm-6 ">
                                    <select class="form-control">
                                        <option>Colonne 2</option>

                                    </select>
                                </div>



                            </div>

                            <div id="content" class='hidden'>

                            </div>

                        </div>

                        <div id="loader" >

                        </div>

                        <!----------------------------------------------------------------------------------------->
                        <!----------------------------------------------------------------------------------------->
                        <!----------------------------------------------------------------------------------------->





                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <!-- /page content -->


{% endblock %}


{% block js %}
    <script>
        var nbChecked = 0;
        var tab = "" ;
        var col1 = "" ;
        var col2 = "" ;
        $(document).ready(function(){
            document.getElementById("loader").style.display = "none";
            document.getElementById("col1List").style.visibility = "visible";
            document.getElementById("col2List").style.visibility = "hidden";
            document.getElementById("chartList").style.visibility = "hidden";
            showTabList();
        })
        function showTabList() {
            document.getElementById("loader").style.display = "none";
            var base_url = window.location.origin;
            var urlAPI = base_url+"/dashboard/listTables"
            $.getJSON( urlAPI, function( data ) {

                //    alert(data);
                var select = $("<select class=\"form-control\"></select>").attr("id", "tables").attr("onchange", "selectedTables(this.value)");
                select.append($("<option></option>").attr("value", "").text("Table"));
                var data_length = data.length;
                for (var i = 0; i < data_length; i++) {
                    select.append($("<option></option>").attr("value", data[i]["TABLE_NAME"]).text(data[i]["TABLE_NAME"]));
                }
                $("#tabList").html(select);

            });
        }

        function selectedTables(val) {

            document.getElementById("loader").style.display = "block";
            if (val=="") {
                showTabList();
                document.getElementById("chartList").style.visibility = "hidden";
                document.getElementById("col1List").style.visibility = "hidden";
                document.getElementById("col2List").style.visibility = "hidden";
                document.getElementById("content").style.visibility = "hidden";
                return;
            } else {
                document.getElementById("col2List").style.visibility = "hidden";
                document.getElementById("chartList").style.visibility = "hidden";
                document.getElementById("content").style.visibility = "hidden";
                tab = val ;
                nbChecked = 0 ;
                showCol1List(val);
            }


        }

        function showCol1List(val) {

            document.getElementById("col1List").style.visibility = "visible";
            document.getElementById("loader").style.display = "none";
            var base_url = window.location.origin;
            var urlAPI = base_url+"/dashboard/getColumns?tab=" + val
            $.getJSON( urlAPI, function( data ) {
                /*   var select = $("<select class=\"form-control\"></select>").attr("id", "tables").attr("onchange", "selectedCol1(this.value)");
                   select.append($("<option></option>").attr("value", "").text("Colonne 1"));
                   var data_length = data.length; */

                var container = $('#col1List');
                $("#col1List").html("");
                var inputs = container.find('input');
                for (var i = 0; i < data.length; i++) {

                    lib = "    " + data[i]["COLUMN_NAME"];
                    $('<input />', { type: 'checkbox', id: data[i]["COLUMN_NAME"], value: data[i]["COLUMN_NAME"] , class:"flat" , onclick:'checkboxChange(this);' }).appendTo(container);

                    $('<label />', { 'for': data[i]["COLUMN_NAME"], text:data[i]["COLUMN_NAME"] , style:'padding-left:20px'}).appendTo(container);
                    $('<br>').appendTo(container);

                }
                // $("#col1List").html(select);
            });
        }
        function checkboxChange(cb){
            if (cb.checked == false){
                nbChecked = nbChecked - 1 ;
                if (nbChecked == 0) {
                    document.getElementById("chartList").style.visibility = "hidden";
                }
            } else {
                if (nbChecked==0){
                    col1 = cb.value;
                    nbChecked = nbChecked + 1 ;
                } else if (nbChecked==1){
                    col2 = cb.value;
                    nbChecked = nbChecked + 1 ;
                } else {
                    nbChecked = nbChecked + 1 ;
                    document.getElementById("chartList").style.visibility = "hidden";
                    document.getElementById("content").style.visibility = "hidden";
                    alert("Maximum 2 colonnes Ã  selectionner ");
                }
            }

            if (nbChecked == 1 ) {
                document.getElementById("chartList").style.visibility = "visible";
                document.getElementById("content").style.visibility = "hidden";
                showPieChartList();
            } else if (nbChecked == 2){
                document.getElementById("chartList").style.visibility = "visible";
                document.getElementById("content").style.visibility = "hidden";
                showAllChartList();
            }
        }
        function selectedCol1(val) {
            if (val=="") {
                document.getElementById("chartList").style.visibility = "hidden";
                document.getElementById("col2List").style.visibility = "hidden";
                document.getElementById("content").style.visibility = "hidden";
            } else {
                document.getElementById("chartList").style.visibility = "visible";
                document.getElementById("col2List").style.visibility = "visible";
                document.getElementById("content").style.visibility = "hidden";
                showCol2List();
                showPieChartList();
            };
        }


        function selectedCol2(val) {
            if (val=="") {
                document.getElementById("content").style.visibility = "hidden";
                showPieChartList();

            } else {
                document.getElementById("content").style.visibility = "hidden";
                showAllChartList();
            };
        }

        function showPieChartList() {
            var select = $("<select class=\"form-control\"></select>").attr("id", "listChart").attr("onchange", "showGraph(this.value)");
            select.append($("<option></option>").attr("value", "").text("Chart"));
            select.append($("<option></option>").attr("value", "Pie Chart").text("Pie Chart"));


            $("#chartList").html(select);

        }
        function showAllChartList() {
            var select = $("<select class=\"form-control\"></select>").attr("id", "listChart").attr("onchange", "showGraph(this.value)");
            select.append($("<option></option>").attr("value", "").text("Chart"));
            select.append($("<option></option>").attr("value", "Pie Chart").text("Pie Chart"));
            select.append($("<option></option>").attr("value", "Bar Chart").text("Bar Chart"));
            select.append($("<option></option>").attr("value", "Line Chart").text("Line Chart"));

            $("#chartList").html(select);
        }


        function showCol2List() {
            var val = $('#tabList').find(":selected").text();
            var base_url = window.location.origin;
            var urlAPI = base_url+"/dashboard/getColumns?tab=" + val;
            $.getJSON( urlAPI, function( data ) {
                var select = $("<select class=\"form-control\"></select>").attr("id", "tables").attr("onchange", "selectedCol2(this.value)");
                select.append($("<option></option>").attr("value", "").text("Colonne 2"));
                var data_length = data.length;
                for (var i = 0; i < data_length; i++) {
                    select.append($("<option></option>").attr("value", data[i]["COLUMN_NAME"]).text(data[i]["COLUMN_NAME"]));
                }
                $("#col2List").html(select);
            });
        }

    </script>

    <script>

        function showGraph(period) {
            if (period=="") return; // please select - possibly you want something else here
            if (period=="Pie Chart"){
                document.getElementById("loader").style.display = "block";
                chartPie();
            } else  if (period=="Bar Chart"){

                document.getElementById("loader").style.display = "block";
                chartBar();
            } else  if (period=="Line Chart"){
                document.getElementById("loader").style.display = "block";
                ChartLine();
            }
        }
        function chartPie() {
            const div = document.createElement('div');

            div.className = 'row';

            div.innerHTML = `<div id="chartContainer" style="height: 300px; width: 100%;"></div>`;

            document.getElementById('content').innerHTML = "";
            document.getElementById('content').appendChild(div);
            document.getElementById("content").style.visibility = "visible";
            PieChartFill();

        }
        function chartBar() {
            const div = document.createElement('div');

            div.className = 'row';

            div.innerHTML = `  <div id="chartContainer" style="height: 300px; width: 100%;">
                                </div>
                                <div style="margin-top:16px;color:dimgrey;font-size:9px;font-family: Verdana, Arial, Helvetica, sans-serif;text-decoration:none;">
                                </div>`;

            document.getElementById('content').innerHTML = "";
            document.getElementById('content').appendChild(div);
            document.getElementById("content").style.visibility = "visible";

            /*   var val1 = $('#tabList').find(":selected").text()
               var col1 = $('#col1List').find(":selected").text()
               var col2 = $('#col2List').find(":selected").text() */

            val1 = tab;
            col1 = col1;
            col2 = col2;



            var uniques = [];
            var base_url = window.location.origin;
            var urlAPI = base_url+"/dashboard/getUniques?tab="+val1+"&col1="+col1+"" ;
            var myData ;
            $.ajax({
                type:"GET",
                async: false,
                dataType: "json",
                data:{name: name},
                url:urlAPI,
                success:function(data)
                {
                    myData = data;
                }
            });
            console.log(myData);
            for (var i = 0; i < myData.length; i++) {
                uniques.push(myData[i][col1]);
            }
            var uniquesQuery = "";
            for (var i = 0; i < uniques.length; i++){
                var val = uniques[i] ;
                var cnt_val = "cnt_"+ val;
                uniquesQuery = uniquesQuery +  "sum("+col1+" = '"+val+"') as "+cnt_val+","
                uniques[i] = cnt_val;
            }
            uniquesQuery = uniquesQuery.slice(0,-1);

            if (uniques.length < 10) {
                document.getElementById("loader").style.display = "block";
                BarChartFill2(uniques,uniquesQuery);
            } else {
                document.getElementById("loader").style.display = "block";
                BarChartFill();

            }
        }
        function ChartLine() {
            const div = document.createElement('div');

            div.className = 'row';

            div.innerHTML = `  <div id="chartContainer" style="height: 300px; width: 100%;"></div>`;

            document.getElementById('content').innerHTML = "";
            document.getElementById('content').appendChild(div);

            document.getElementById("content").style.visibility = "visible";
            LineChartFill();
        }
    </script>


    <script>

        function BarChartFill(){
            /*      var val1 = $('#tabList').find(":selected").text()
                  var val2 = $('#col1List').find(":selected").text()
                  var val3 = $('#col2List').find(":selected").text() */
            val1 = tab;
            val2 = col1;
            val3 = col2;
            var dataPoints = [];
            var chart = new CanvasJS.Chart("chartContainer",
                {
                    title:{
                        text:   val2 + " par  "+val3
                    },
                    data: [
                        {

                            indexLabelOrientation: "vertical",
                            type: "column",
                            dataPoints: dataPoints
                        },

                    ]
                });
            var base_url = window.location.origin;
            var urlAPI = base_url+"/dashboard/chart?tab="+val1+"&col1="+val2+"&col2=" + val3 +"&chart="+ "barChart"  ;
            $.getJSON(urlAPI, function(data)
            {

                var data_length = data.length;
                for (var i = 0; i < data_length; i++) {
                    dataPoints.push({label: data[i][val2], y: parseInt(data[i][val3])});
                }

                document.getElementById("loader").style.display = "none";
                chart.render();
            })
        }
        function BarChartFill2(uniques , uniquesQuery) {

            /*  var val1 = $('#tabList').find(":selected").text()
              var col1 = $('#col1List').find(":selected").text()
              var col2 = $('#col2List').find(":selected").text()
       */
            val1 = tab;
            col1 = col1;
            col2 = col2;
            var dataPoints = [];
            var chart = new CanvasJS.Chart("chartContainer",
                {
                    title: {
                        text: col1 + " par  " + col2
                    },
                    data: [
                        {

                            indexLabelOrientation: "vertical",
                            type: "column",
                            dataPoints: dataPoints
                        },

                    ]
                });
            var base_url = window.location.origin;
            var urlAPI = base_url + "/dashboard/chart?tab=" + val1 + "&col1=" + col1 + "&col2=" + col2 + "&query=" + uniquesQuery +"&chart="+ "barChart2" ;
            $.getJSON(urlAPI, function (data) {

                    myData = data;
                    for (let i = 0; i < uniques.length; i++) {
                        var val = uniques[i];
                        // alert(" ------- val =  :  " + val + " ------ : " + data[1]["cntH"]);
                        var series2 = {
                            type: "column",
                            name: uniques[i],
                            showInLegend: true
                        };
                        var dataPoints = [];
                        series2.dataPoints = dataPoints;
                        for (let j = 0; j < myData.length; j++) {
                            var stt = j.toString();
                            dataPoints.push({label: myData[j][col2], y: parseInt(myData[j][val])});
                        }
                        chart.options.data.push(series2);
                    }

                    document.getElementById("loader").style.display = "none";
                    chart.render();
                }
            )
        }






        function PieChartFill(){
            var val1 = tab ;
            var val2 = col1;
            var dataPoints = [];
            var chart = new CanvasJS.Chart("chartContainer",
                {
                    theme: "light2",
                    title:{
                        text: "Pourcentages de " + val2
                    },
                    data: [
                        {
                            type: "pie",
                            showInLegend: true,
                            toolTipContent: "{y}  {indexLabel} - #percent % ",
                            yValueFormatString: "#",
                            legendText: "{indexLabel}",
                            dataPoints:  dataPoints,
                        }
                    ]
                });

            var base_url = window.location.origin;
            var urlAPI = base_url+"/dashboard/chart?tab="+val1+"&col1="+ val2+"&chart="+ "pieChart"
            $.getJSON(urlAPI, function(data)
            {
                var data_length = data.length;
                for (var i = 0; i < data_length; i++) {
                    dataPoints.push({indexLabel: data[i][val2], y: parseInt(data[i]["cnt"])});
                }

                document.getElementById("loader").style.display = "none";
                chart.render();
            })
        }
        function LineChartFill(){
            /*     var val1 = $('#tabList').find(":selected").text()
                 var val2 = $('#col1List').find(":selected").text()
                 var val3 = $('#col2List').find(":selected").text() */
            val1 = tab;
            val2 = col1;
            val3 = col2;
            var dataPoints = [];

            var chart = new CanvasJS.Chart("chartContainer",
                {

                    title:{
                        text: val2 + " par "+ val3
                    },
                    data: [
                        {
                            type: "line",

                            dataPoints: dataPoints
                        }
                    ]
                });

            var base_url = window.location.origin;
            var urlAPI = base_url+"/dashboard/chart?tab="+val1+"&col1="+val2+"&col2=" + val3 +"&chart="+ "lineChart" ;
            $.getJSON(urlAPI, function(data) {
                var data_length = data.length;
                for (var i = 0; i < data_length; i++) {
                    $year = data[i][val3].substring(0, 4);

                    $month = data[i][val3].substring(6, 7);

                    $day = data[i][val3].substring(9, 10);
                    /*  dataPoints.push({label: new Date(parseInt($year), parseInt($month) - 1, parseInt($day)), y: parseInt(data[i][val2])});*/
                    dataPoints.push({label: data[i][val3], y: parseInt(data[i][val2])});


                }
                document.getElementById("loader").style.display = "none";
                chart.render();
            })

        }


    </script>
    <script type="text/javascript" src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
{% endblock %}